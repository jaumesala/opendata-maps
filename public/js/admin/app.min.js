SITE={common:{init:function(){}},auth:{init:function(){}},dashboard:{init:function(){}},settings:{init:function(){}},user:{init:function(){}},role:{init:function(){}},permission:{init:function(){}},map:{init:function(){}},source:{init:function(){}}},UTIL={exec:function(e,t){var i=SITE,t=void 0===t?"init":t;""!==e&&i[e]&&"function"==typeof i[e][t]&&i[e][t]()},init:function(){var e=document.body,t=e.getAttribute("data-controller").trim(),i=e.getAttribute("data-action").trim();UTIL.exec("common"),UTIL.exec(t),UTIL.exec(t,i)}},$(document).ready(UTIL.init),mapView={styles:{},mv:this,mode:"viz",init:function(){mapView.mode="viz",mapView.initMap()},editorInit:function(e){mapView.mode="undefined"!=typeof e?e:"default",$.when(mapView.getStyles()).then(function(){mapView.initStylesSelector(),"editor"==mapView.mode?mapView.initMap():mapView.initDefaultMap()})},getStyles:function(){return $.get(env.settings.mapbox.stylesApiUrl+env.settings.mapbox.username+"?access_token="+env.settings.mapbox.accessToken,function(e){mapView.styles=e,"editor"==mapView.mode?env.settings.maps.defaultStyle=map.style:env.settings.maps.defaultStyle=e[0].id})},initStylesSelector:function(){for(var e in mapView.styles)if(mapView.styles.hasOwnProperty(e)){var t=mapView.styles[e];$("<option/>").val(t.id).text(t.name).data("obj",t).appendTo($("#style"))}"editor"==mapView.mode?$("#style").val(map.style).trigger("change"):$("#style").val(env.settings.maps.defaultStyle).trigger("change")},initDefaultMap:function(){mapboxgl.accessToken=env.settings.mapbox.accessToken,mapView.map=new mapboxgl.Map({container:"map-view",style:"mapbox://styles/"+env.settings.mapbox.username+"/"+env.settings.maps.defaultStyle,center:[env.settings.maps.defaultLongitude,env.settings.maps.defaultLatitude],zoom:env.settings.maps.defaultZoom,pitch:0,bearing:env.settings.maps.defaultBearing,attributionControl:!1}),mapView.map.addControl(new mapboxgl.Navigation),mapView.bindControls()},initMap:function(){mapboxgl.accessToken=env.settings.mapbox.accessToken,mapView.map=new mapboxgl.Map({container:"map-view",style:"mapbox://styles/"+env.settings.mapbox.username+"/"+map.style,center:[map.longitude,map.latitude],zoom:map.zoom,pitch:0,bearing:map.bearing,attributionControl:!1}),mapView.map.on("style.load",function(){mapView.map.addControl(new mapboxgl.Navigation),"editor"!=mapView.mode&&mapView.bindControls(),mapView.addMapSources(),mapView.addMapLayers()})},bindControls:function(){$("#style").on("change",function(){mapView.map.setStyle("mapbox://styles/"+env.settings.mapbox.username+"/"+$(this).val())}),mapView.map.on("move",function(){var e=mapView.map.getCenter();$("#latitude, #latitudeDisabled").val(e.lat),$("#longitude, #longitudeDisabled").val(e.lng)}),mapView.map.on("zoom",function(){var e=mapView.map.getZoom();$("#zoom, #zoomDisabled").val(Math.round(e))}),mapView.map.on("rotate",function(){var e=mapView.map.getBearing();$("#bearing, #bearingDisabled").val(Math.round(e))})},addMapSources:function(){sources=[],_.each(map.layers,function(e){sources.push(e.source)}),sources=_.uniq(sources,_.property("id")),map.sources=sources,_.each(map.sources,function(e){mapView.map.addSource("source-"+e.id,{type:"geojson",data:"/sources/"+e.hash+".geojson"})})},addChoroplethSource:function(e,t){mapView.map.addSource("choropleth-layer-"+t.id,{type:"geojson",data:e})},getPaintRules:function(e,t){var i={};if(_.contains(t,"dasharray")){if(e.dasharray.length){var a=e.dasharray.split(","),o=_.map(a,function(e){return parseInt(e)});i[e.type+"-dasharray"]=o}var n=t.indexOf("dasharray");t.splice(n,1)}return _.each(t,function(t){return"opacity"==t?void(i[e.type+"-opacity"]=e.opacity/10):void(e[t]&&(i[e.type+"-"+t]=e[t]))}),i},getChoroplethClusters:function(e,t){var i=e.clusters,a=e["schema-color"]?e["schema-color"]:"YlOrRd",o=chroma.scale(a).colors(i);e["schema-reverse"]&&o.reverse();var n=turf.jenks(t,"pt_count",i-1).reverse();return _.zip(o,n)},addLayer:function(e,t,i){mapView.map.addLayer({id:"layer-"+e.id,type:e.type,source:"source-"+e.source.id,interactive:!!e.interactive,paint:t,layout:i,minzoom:e.minzoom,maxzoom:e.maxzoom})},addChoroplethLayers:function(e,t,i,a){var o=void 0;"undefined"!=typeof a&&(o="layer-"+a.id),_.each(e,function(e,a){mapView.map.addLayer({id:"layer-"+i.id+"-choropleth-"+a,type:"fill",source:"choropleth-layer-"+i.id,paint:{"fill-color":e[0],"fill-opacity":i.opacity/10},layout:t,minzoom:i.minzoom,maxzoom:i.maxzoom},o)})},filterChoroplethLayers:function(e,t){_.each(e,function(i,a){var o=["all",[">=","pt_count",i[1]]];0!==a&&o.push(["<","pt_count",e[a-1][1]]),mapView.map.setFilter("layer-"+t.id+"-choropleth-"+a,o)})},addHeatmapSource:function(e,t){mapView.map.addSource("heatmap-layer-"+t.id,{type:"geojson",data:e,cluster:!0,clusterMaxZoom:15,clusterRadius:20})},getHeatmapClusters:function(e,t){var i=e.clusters,a=e["schema-color"]?e["schema-color"]:"YlOrRd",o=chroma.scale(a).colors(i);e["schema-reverse"]&&o.reverse();var n=turf.jenks(t,"pt_count",i-1);return _.zip(o,n)},addHeatmapLayers:function(e,t,i,a){var o=void 0;"undefined"!=typeof a&&(o="layer-"+a.id),mapView.map.addLayer({id:"layer-"+i.id+"-cluster-no",type:"circle",source:"heatmap-layer-"+i.id,paint:{"circle-color":e[0][0],"circle-radius":i.radius,"circle-blur":i.blur},layout:t,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:["!=","cluster",!0]},"waterway-label"),e.forEach(function(a,o){var n=o===e.length-1?[">=","point_count",a[1]]:["all",[">=","point_count",a[1]],["<","point_count",e[o+1][1]]];mapView.map.addLayer({id:"layer-"+i.id+"-cluster-"+o,type:"circle",source:"heatmap-layer-"+i.id,paint:{"circle-color":a[0],"circle-radius":i.radius,"circle-blur":i.blur},layout:t,minzoom:i.minzoom,maxzoom:i.maxzoom,filter:n},"waterway-label")})},addMapLayers:function(){layers=map.layers.reverse(),_.each(layers,function(e,t){var i={},a={},o=e.type;switch(o){case"fill":i=mapView.getPaintRules(e,["opacity","color","outline-color"]),a.visibility=e.visible?"visible":"none",mapView.addLayer(e,i,a);break;case"line":i=mapView.getPaintRules(e,["opacity","color","width","gap-width","blur","dasharray"]),a.visibility=e.visible?"visible":"none",mapView.addLayer(e,i,a);break;case"circle":i=mapView.getPaintRules(e,["opacity","color","radius","blur"]),a.visibility=e.visible?"visible":"none",mapView.addLayer(e,i,a);break;case"choropleth":a.visibility=e.visible?"visible":"none";var n=$.getJSON("/sources/"+e.source.hash+".geojson"),r=$.getJSON("/sources/"+e["choropleth-source"]+".geojson");$.when(n,r).done(function(i,o){var n=turf.count(o[0],i[0],"pt_count");mapView.addChoroplethSource(n,e);var r=mapView.getChoroplethClusters(e,n),s=layers[t+1];mapView.addChoroplethLayers(r,a,e,s),mapView.filterChoroplethLayers(r,e)});break;case"heatmap":a.visibility=e.visible?"visible":"none";var n=$.getJSON("/sources/"+e.source.hash+".geojson");$.when(n).done(function(i){var o=turf.extent(i),n=.2,r="kilometers",s=turf.squareGrid(o,n,r),c=turf.count(s,i,"pt_count");mapView.addHeatmapSource(i,e);var l=mapView.getHeatmapClusters(e,c),d=layers[t+1];mapView.addHeatmapLayers(l,a,e,d)})}})}},SITE.auth.email=function(){},SITE.auth.login=function(){$("input").iCheck({checkboxClass:"icheckbox_square-blue",radioClass:"iradio_square-blue",increaseArea:"20%"})},SITE.auth.register=function(){},SITE.auth.reset=function(){},SITE.dashboard.index=function(){},SITE.map.create=function(){var e=$(".select2");e.each(function(){$(this).css("width","100%").select2($(this).data("options"))}),$window=$(window),$mapView=$("#map-view"),$controlsView=$("#controls-view"),$mapView.height($window.height()-195),$controlsView.height($window.height()-175),$window.resize(function(){$mapView.height($window.height()-195),$controlsView.height($window.height()-175)}),mapView.editorInit()},SITE.map.edit=function(){function e(e,t){t.each(function(){var t=$(this).data("filter");t.indexOf(e)>-1?$(this).addClass("show").removeClass("hide"):$(this).addClass("hide").removeClass("show")})}var t=$(".select2");t.each(function(){$(this).css("width","100%").select2($(this).data("options"))}),$window=$(window),$mapView=$("#map-view"),$controlsView=$("#controls-view"),$mapView.height($window.height()-195),$controlsView.height($window.height()-175),$controlsView.find(".tab-content").height($window.height()-175-64),$window.resize(function(){$mapView.height($window.height()-195),$controlsView.height($window.height()-175)}),$("#tab-layers > .tab-wrapper").slimScroll({height:"auto",distance:"2px"}),$(".sublist-wrapper").slimScroll({height:"80px",distance:"2px",size:"3px"}),$("#confirmDelete").on("show.bs.modal",function(e){var t=$(e.relatedTarget),i=t.data("action"),a=t.data("id"),o=$(this);o.find("form").attr("action",i),o.find("input[name=id]").attr("value",a)}),$.ajaxSetup({headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")}}),$("#layers").sortable({axis:"y",cursor:"move",placeholder:"sort-highlight",handle:".box-header",forcePlaceholderSize:!0,zIndex:999999,update:function(e,t){var i=$(this).sortable("serialize");$.ajax({data:i,type:"POST",url:$(this).data("sort-url")})}}),$(".layerType").change(function(){var t=$(this).val(),i=$(this).closest(".box-body").find(".paintRules .form-group"),a=$(this).closest(".box-body").find(".layoutRules .form-group");e(t,i),e(t,a)}),$(".layerType").trigger("change"),$(".colorpicker").colorpicker({format:"hex",colorSelectors:{"#000000":"#000000","#ffffff":"#ffffff","#5bc0de":"#5bc0de","#337ab7":"#337ab7","#5cb85c":"#5cb85c","#f0ad4e":"#f0ad4e","#d9534f":"#d9534f"}}),mapView.editorInit("editor")},SITE.map.index=function(){$("#confirmDelete").on("show.bs.modal",function(e){var t=$(e.relatedTarget),i=t.data("action"),a=t.data("id"),o=$(this);o.find("form").attr("action",i),o.find("input[name=id]").attr("value",a)})},SITE.map.show=function(){$window=$(window),$mapView=$("#map-view"),$mapView.height($window.height()-195),$window.resize(function(){$mapView.height($window.height()-195)}),mapView.init()},SITE.permission.index=function(){$("#confirmDelete").on("show.bs.modal",function(e){var t=$(e.relatedTarget),i=t.data("action"),a=t.data("id"),o=$(this);o.find("form").attr("action",i),o.find("input[name=id]").attr("value",a)})},SITE.settings.index=function(){},SITE.role.create=function(){var e=$(".select2"),t=e.data("old").toString().split(",");$(".select2").css("width","100%").select2().val(t).trigger("change")},SITE.role.edit=function(){var e=$(".select2"),t=e.data("old").toString().split(",");$(".select2").css("width","100%").select2().val(t).trigger("change")},SITE.role.index=function(){$("#confirmDelete").on("show.bs.modal",function(e){var t=$(e.relatedTarget),i=t.data("action"),a=t.data("id"),o=$(this);o.find("form").attr("action",i),o.find("input[name=id]").attr("value",a)})},SITE.source.create=function(){var e=window.location.hash;$('#create-options a[href="'+e+'"]').tab("show");$(".select2");$(".select2").css("width","100%").select2({minimumResultsForSearch:-1});var t=$("#origin_url"),i=$("#origin_url_check"),a=$("#origin_format_static"),o=$("#origin_size_static");t.keyup(function(){$(this).val()?i.prop("disabled",!1):i.prop("disabled",!0)}),i.click(function(e){e.preventDefault();var n=t.val(),r=i.data("url");n&&($(i).find(".text").addClass("hidden"),$(i).find(".spin").removeClass("hidden"),$.get(r,{origin_url:n},function(e,t,n){if(200==n.status){var r=e.data.fileSize,s=e.data.fileType;a.text(s),o.text(r)}$(i).find(".text").removeClass("hidden"),$(i).find(".spin").addClass("hidden")}))})},SITE.source.edit=function(){$(".select2");$(".select2").css("width","100%").select2({minimumResultsForSearch:-1})},SITE.source.index=function(){$("#confirmDelete").on("show.bs.modal",function(e){var t=$(e.relatedTarget),i=t.data("action"),a=t.data("id"),o=$(this);o.find("form").attr("action",i),o.find("input[name=id]").attr("value",a)})},SITE.source.show=function(){$("#confirmDelete").on("show.bs.modal",function(e){var t=$(e.relatedTarget),i=t.data("action"),a=t.data("id"),o=$(this);o.find("form").attr("action",i),o.find("input[name=id]").attr("value",a)})},SITE.user.create=function(){var e=$(".select2"),t=e.data("old").toString().split(",");$(".select2").css("width","100%").select2().val(t).trigger("change")},SITE.user.edit=function(){var e=$(".select2"),t=e.data("old").toString().split(",");$(".select2").css("width","100%").select2().val(t).trigger("change")},SITE.user.index=function(){$("#confirmDelete").on("show.bs.modal",function(e){var t=$(e.relatedTarget),i=t.data("action"),a=t.data("id"),o=$(this);o.find("form").attr("action",i),o.find("input[name=id]").attr("value",a)})};